graph TD
    subgraph "External World"
        iot_devices[IoT Devices]
        users[Users / UI]
    end

    subgraph "On-Premise Infrastructure"
        api_gateway[API Gateway]

        subgraph "Kubernetes Cluster"
            direction LR
            subgraph "Service Mesh (e.g., Istio)"
                ms_device[Device Management Service]
                ms_ingestion[Data Ingestion Service]
                ms_processing[Telemetry Processing Service]
                ms_alerting[Alerting Service]
                ms_users[User Management Service]
                ms_reporting[Reporting Service]
            end

            subgraph "Data Tier (Polyglot Persistence)"
                db_device[PostgreSQL - Devices]
                db_timeseries[InfluxDB/TimescaleDB - Telemetry]
                db_users[PostgreSQL - Users]
                cache[Redis - Cache/Sessions]
            end

            subgraph "Observability Stack"
                prometheus[Prometheus - Metrics]
                grafana[Grafana - Dashboards]
                efk[EFK Stack - Logging]
                jaeger[Jaeger - Tracing]
            end
        end

        subgraph "Event-Driven Backbone"
            kafka[Apache Kafka]
        end

        subgraph "CI/CD & Tooling"
            gitlab[GitLab / Jenkins]
            harbor[Harbor - Container Registry]
        end
    end

    %% Connections
    iot_devices -->|MQTT/HTTP| api_gateway
    users -->|HTTPS| api_gateway

    api_gateway --> ms_device
    api_gateway --> ms_ingestion
    api_gateway --> ms_users
    api_gateway --> ms_reporting

    ms_device <--> db_device
    ms_users <--> db_users
    ms_reporting <--> db_timeseries
    ms_processing <--> db_timeseries
    ms_processing <--> cache

    ms_ingestion --> kafka
    kafka --> ms_processing
    ms_processing --> kafka
    kafka --> ms_alerting

    %% CI/CD Flow
    gitlab --> harbor
    gitlab --> Kubernetes

    %% Observability Connections
    ms_device --> prometheus
    ms_ingestion --> prometheus
    ms_processing --> prometheus
    ms_alerting --> prometheus
    ms_users --> prometheus
    ms_reporting --> prometheus

    ms_device --> efk
    ms_ingestion --> efk
    ms_processing --> efk
    ms_alerting --> efk
    ms_users --> efk
    ms_reporting --> efk

    ms_device --> jaeger
    ms_ingestion --> jaeger
    ms_processing --> jaeger
    ms_alerting --> jaeger
    ms_users --> jaeger
    ms_reporting --> jaeger

    prometheus --> grafana
